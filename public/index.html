<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Duty State Dev Branch</title>
    <!-- Web App Manifest for PWA -->
    <link rel="manifest" href="/manifest.json">
    <!-- Favicon for app-like experience -->
    <link rel="apple-touch-icon" href="/icon.png">
    <style>
        :root {
            --primary-color: #3e6ae1;
            --primary-hover: #2e55b8;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --border-color: #d0d7de;
            --text-color: #171717;
            --text-secondary: #5e5e5e;
            --input-bg: #fafafa;
            --accent-color: #ff6f61;
        }

        [data-theme="dark"] {
            --primary-color: #5e80ff;
            --primary-hover: #476cd9;
            --bg-color: #1a1a1a;
            --card-bg: #252525;
            --border-color: #383838;
            --text-color: #e0e0e0;
            --text-secondary: #8a8a8a;
            --input-bg: #2e2e2e;
            --accent-color: #ff8a80;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Helvetica Neue', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .container, .setup-container {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            margin: 20px;
            transition: background-color 0.3s ease, box-shadow 0.2s ease;
        }

        .container:hover, .setup-container:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .setup-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
            opacity: 0;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .setup-container.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .setup-container.hidden {
            display: none;
        }

        .setup-slides {
            display: flex;
            width: 500%;
            transition: transform 0.5s ease-in-out;
        }

        .setup-slide {
            width: 20%;
            padding: 2rem;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        .setup-slide.active {
            opacity: 1;
            transform: translateY(0);
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .overlay.active {
            display: block;
        }

        .pin-prompt {
            display: none;
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-bg);
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            animation: slideIn 0.5s ease-out forwards;
            border: 1px solid var(--border-color);
        }

        .pin-prompt.show {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .pin-prompt p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .pin-prompt button {
            padding: 0.5rem 1rem;
            background-color: var(--primary-color);
            color: #ffffff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .pin-prompt button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .setup-header { text-align: center; margin-bottom: 2rem; }
        .setup-header h1 { font-size: 2rem; font-weight: 700; color: var(--primary-color); margin-bottom: 0.5rem; }
        .setup-header p { font-size: 1rem; color: var(--text-secondary); font-weight: 400; }
        .welcome-icon { font-size: 3rem; margin-bottom: 1rem; color: var(--accent-color); animation: bounce 1.5s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-color); font-size: 0.9rem; }
        input[type="url"], input[type="text"], select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; transition: all 0.2s ease; background-color: var(--input-bg); color: var(--text-color); box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); }
        input[type="url"]:focus, input[type="text"]:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 6px rgba(62, 106, 225, 0.3); }
        select { appearance: none; background: var(--input-bg) url('data:image/svg+xml;utf8,<svg fill="%235e5e5e" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 0.75rem center; background-size: 1rem; }
        [data-theme="dark"] select { background: var(--input-bg) url('data:image/svg+xml;utf8,<svg fill="%238a8a8a" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>') no-repeat right 0.75rem center; }
        .theme-options { display: flex; gap: 1rem; justify-content: center; margin-bottom: 1.5rem; }
        .theme-btn { padding: 0.75rem 1.5rem; border: 2px solid var(--primary-color); border-radius: 8px; background: none; color: var(--text-color); cursor: pointer; transition: all 0.3s ease; font-weight: 600; position: relative; overflow: hidden; }
        .theme-btn::after { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: rgba(255, 255, 255, 0.2); border-radius: 50%; transform: translate(-50%, -50%); transition: width 0.4s ease, height 0.4s ease; }
        .theme-btn:hover::after { width: 200%; height: 200%; }
        .theme-btn.selected { background-color: var(--primary-color); color: #ffffff; }
        .color-picker { display: flex; align-items: center; gap: 1rem; background: var(--input-bg); padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border-color); }
        input[type="color"] { width: 50px; height: 50px; border: none; padding: 0; background: none; cursor: pointer; border-radius: 50%; transition: transform 0.2s ease; }
        input[type="color"]:hover { transform: scale(1.1); }
        .nav-buttons { display: flex; gap: 1rem; margin-top: 2rem; }
        .nav-buttons button { width: 50%; padding: 0.75rem; border-radius: 8px; font-weight: 600; transition: all 0.3s ease; }
        .nav-buttons button:disabled { background-color: var(--text-secondary); cursor: not-allowed; transform: none; }
        .lets-go-btn { background: linear-gradient(135deg, var(--primary-color), var(--primary-hover)); position: relative; overflow: hidden; }
        .lets-go-btn::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: rgba(255, 255, 255, 0.3); border-radius: 50%; transform: translate(-50%, -50%); transition: width 0.6s ease, height 0.6s ease; }
        .lets-go-btn:hover::before { width: 300%; height: 300%; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        h1 { color: var(--text-color); font-size: 1.75rem; font-weight: 600; }
        .settings-btn { padding: 0.5rem 1rem; background-color: var(--primary-color); color: #ffffff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: background-color 0.2s ease, transform 0.2s ease; }
        .settings-btn:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        .time-note { font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem; margin-bottom: 0.5rem; }
        .time-note.hidden { display: none; }
        button { width: 100%; padding: 0.85rem; background-color: var(--primary-color); color: #ffffff; border: none; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease, transform 0.2s ease; position: relative; }
        button:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        .spinner { display: none; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #ffffff; border-radius: 50%; animation: spin 0.6s linear infinite; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        button.loading .spinner { display: block; }
        button.loading span { opacity: 0; }
        #output { margin-top: 2rem; display: none; }
        #output h2 { color: var(--text-color); margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600; }
        #outputText { background-color: var(--input-bg); padding: 1rem; border: 1px solid var(--border-color); border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; font-family: 'SF Mono', 'IBM Plex Mono', monospace; font-size: 0.9rem; line-height: 1.6; color: var(--text-color); }
        .toolbar { display: flex; align-items: center; gap: 0.5rem; margin: 0.5rem 0 1rem; }
        .toolbar button { width: auto; padding: 0.55rem 0.9rem; font-size: 0.9rem; }
        .toolbar .pill { background: var(--input-bg); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 999px; padding: 0.4rem 0.75rem; font-weight: 600; }
        .status-message { margin-bottom: 1rem; padding: 0.85rem 1rem; border-radius: 8px; border: 1px solid transparent; display: none; }
        .status-message.success { background: rgba(40, 167, 69, 0.08); border-color: rgba(40, 167, 69, 0.35); color: #1f7a3d; }
        .status-message.error { background: rgba(220, 53, 69, 0.08); border-color: rgba(220, 53, 69, 0.35); color: #8a1c2c; }
        .status-message.info { background: rgba(0, 123, 255, 0.08); border-color: rgba(0, 123, 255, 0.35); color: #0b4f99; }
        .settings-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--card-bg); padding: 1.5rem; border-radius: 8px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); width: 100%; max-width: 400px; z-index: 1000; transition: background-color 0.3s ease; }
        .settings-modal.active { display: block; }
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .settings-header h2 { font-size: 1.25rem; font-weight: 600; color: var(--text-color); }
        .close-btn { background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; transition: color 0.2s ease; }
        .close-btn:hover { color: var(--text-color); }
        .settings-content { font-size: 0.9rem; }
        .settings-content p { margin-bottom: 1rem; }
        .api-status { font-weight: 500; }
        .api-status.connected { color: #28a745; }
        .api-status.disconnected { color: #dc3545; }
        .theme-toggle { background-color: var(--primary-color); color: #ffffff; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: background-color 0.2s ease, transform 0.2s ease; width: 100%; margin-bottom: 1rem; }
        .theme-toggle:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        .reset-btn { background: none; color: var(--text-secondary); border: none; width: 100%; text-align: left; cursor: pointer; font-size: 0.9rem; transition: color 0.2s ease; }
        .reset-btn:hover { color: var(--text-color); }
        .custom-dropdown { position: relative; width: 100%; }
        .dropdown-toggle { width: 100%; padding: 0.5rem 2.5rem 0.5rem 1rem; background: linear-gradient(135deg, var(--primary-color), var(--primary-hover)); color: var(--text-color); border: none; border-radius: 6px; font-weight: 500; font-size: 0.9rem; cursor: pointer; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); transition: all 0.2s ease; background-image: url('data:image/svg+xml;utf8,<svg fill="%23171717" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>'); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1rem; text-align: left; }
        [data-theme="dark"] .dropdown-toggle { color: #ffffff; background-image: url('data:image/svg+xml;utf8,<svg fill="%23ffffff" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>'); }
        .dropdown-toggle:hover { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); transform: scale(1.01); }
        .dropdown-toggle.active { border-bottom-left-radius: 0; border-bottom-right-radius: 0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .dropdown-menu { display: none; position: absolute; top: 100%; left: 0; width: 100%; background-color: var(--card-bg); border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 6px 6px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); z-index: 1001; }
        .dropdown-menu.active { display: block; }
        .dropdown-option { padding: 0.5rem 1rem; color: var(--text-color); font-weight: 500; cursor: pointer; transition: background-color 0.2s ease, padding-left 0.2s ease; }
        .dropdown-option:hover { background-color: rgba(0, 0, 0, 0.05); padding-left: 1.15rem; }
        [data-theme="dark"] .dropdown-option:hover { background-color: rgba(255, 255, 255, 0.1); }
        .api-note { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem; }
        @media (max-width: 640px) { .container, .settings-modal, .setup-container { margin: 10px; padding: 1.5rem; } }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    <div class="pin-prompt" id="pinPrompt">
        <p>Pin "Duty State" to your menu bar for quick access!</p>
        <button id="pinButton">Pin Now</button>
    </div>
    <div class="setup-container" id="setupContainer">
        <div class="setup-slides" id="setupSlides">
            <div class="setup-slide" data-step="0">
                <div class="setup-header">
                    <div class="welcome-icon">ðŸŽ‰</div>
                    <h1>Welcome aboard!</h1>
                    <p>Pick a vibe to get started</p>
                </div>
                <div class="form-group">
                    <label>Choose Theme:</label>
                    <div class="theme-options">
                        <button type="button" class="theme-btn selected" data-theme="light">Light</button>
                        <button type="button" class="theme-btn" data-theme="dark">Dark</button>
                    </div>
                </div>
                <div class="nav-buttons">
                    <button type="button" id="prevStep0" disabled>Previous</button>
                    <button type="button" id="nextStep0">Next</button>
                </div>
            </div>
            <div class="setup-slide" data-step="1">
                <div class="setup-header">
                    <h1>Your Timezone</h1>
                    <p>Where are you at?</p>
                </div>
                <div class="form-group">
                    <label for="yourTimezone">Your Timezone:</label>
                    <select id="yourTimezone" name="yourTimezone" required>
                        <option value="" disabled selected>Select your timezone</option>
                        <option value="America/New_York">New York (EST/EDT)</option>
                        <option value="America/Los_Angeles">Los Angeles (PST/PDT)</option>
                        <option value="America/Chicago">Chicago (CST/CDT)</option>
                        <option value="Europe/London">London (GMT/BST)</option>
                        <option value="Europe/Paris">Paris (CET/CEST)</option>
                        <option value="Asia/Jerusalem">Israel (GMT+2/+3)</option>
                        <option value="Asia/Tokyo">Tokyo (JST)</option>
                        <option value="Australia/Sydney">Sydney (AEST/AEDT)</option>
                        <option value="Pacific/Auckland">Auckland (NZST/NZDT)</option>
                        <option value="Asia/Dubai">Dubai (GST)</option>
                        <option value="UTC">Coordinated Universal Time (UTC)</option>
                    </select>
                </div>
                <div class="nav-buttons">
                    <button type="button" id="prevStep1">Previous</button>
                    <button type="button" id="nextStep1">Next</button>
                </div>
            </div>
            <div class="setup-slide" data-step="2">
                <div class="setup-header">
                    <h1>Time Conversion</h1>
                    <p>Where should we convert to?</p>
                </div>
                <div class="form-group">
                    <label for="convertTimezone">Convert To:</label>
                    <select id="convertTimezone" name="convertTimezone" required>
                        <option value="" disabled selected>Select a timezone</option>
                        <option value="disable">No conversion</option>
                        <option value="America/New_York">New York (EST/EDT)</option>
                        <option value="America/Los_Angeles">Los Angeles (PST/PDT)</option>
                        <option value="America/Chicago">Chicago (CST/CDT)</option>
                        <option value="Europe/London">London (GMT/BST)</option>
                        <option value="Europe/Paris">Paris (CET/CEST)</option>
                        <option value="Asia/Jerusalem">Israel (GMT+2/+3)</option>
                        <option value="Asia/Tokyo">Tokyo (JST)</option>
                        <option value="Australia/Sydney">Sydney (AEST/AEDT)</option>
                        <option value="Pacific/Auckland">Auckland (NZST/NZDT)</option>
                        <option value="Asia/Dubai">Dubai (GST)</option>
                        <option value="UTC">Coordinated Universal Time (UTC)</option>
                    </select>
                </div>
                <div class="nav-buttons">
                    <button type="button" id="prevStep2">Previous</button>
                    <button type="button" id="nextStep2">Next</button>
                </div>
            </div>
            <div class="setup-slide" data-step="3">
                <div class="setup-header">
                    <h1>Your Info</h1>
                    <p>Tell us about yourself</p>
                </div>
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" name="username" required placeholder="e.g., 798ty7th">
                </div>
                <div class="form-group">
                    <label for="duty">Duty:</label>
                    <input type="text" id="duty" name="duty" required placeholder="e.g., ARD Duties">
                </div>
                <div class="nav-buttons">
                    <button type="button" id="prevStep3">Previous</button>
                    <button type="button" id="nextStep3">Next</button>
                </div>
            </div>
            <div class="setup-slide" data-step="4">
                <div class="setup-header">
                    <h1>Make it Yours</h1>
                    <p>Pick a button color</p>
                </div>
                <div class="form-group">
                    <label>Button Color:</label>
                    <div class="color-picker">
                        <input type="color" id="buttonColor" name="buttonColor" value="#3e6ae1">
                        <span>Default: #3e6ae1</span>
                    </div>
                </div>
                <div class="nav-buttons">
                    <button type="button" id="prevStep4">Previous</button>
                    <button type="button" id="finishSetup" class="lets-go-btn">Let's Go!</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer">
        <div class="header">
            <h1>Duty State Dev Branch</h1>
            <button class="settings-btn">Settings</button>
        </div>
        <div class="status-message" id="statusMessage" role="status" aria-live="polite"></div>
        <form id="dutyForm">
            <div class="form-group">
                <label for="dutyScreenshot">Duty Screenshot URL:</label>
                <input type="url" id="dutyScreenshot" name="dutyScreenshot" required>
            </div>
            <div class="form-group">
                <label for="timeStarted">Time Started (HH:MM):</label>
                <div class="time-note" id="timeStartedNote"></div>
                <input type="text" id="timeStarted" name="timeStarted" placeholder="e.g., 14:30" required>
            </div>
            <div class="form-group">
                <label for="tablistStarted">Tablist Started URL:</label>
                <input type="url" id="tablistStarted" name="tablistStarted" required>
            </div>
            <div class="form-group">
                <label for="timeEnded">Time Ended (HH:MM):</label>
                <div class="time-note" id="timeEndedNote"></div>
                <input type="text" id="timeEnded" name="timeEnded" placeholder="e.g., 15:30" required>
            </div>
            <div class="form-group">
                <label for="tablistEnded">Tablist Ended URL:</label>
                <input type="url" id="tablistEnded" name="tablistEnded" required>
            </div>
            <button type="submit"><span>Generate Log</span><div class="spinner"></div></button>
        </form>
        <div id="output">
            <h2>Generated Log</h2>
            <div class="toolbar">
                <span class="pill" id="conversionSummary">Conversion ready</span>
                <button type="button" id="copyLog">Copy log</button>
            </div>
            <pre id="outputText"></pre>
        </div>
    </div>

    <div class="settings-modal" id="settingsModal">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="close-btn" id="closeSettings">Ã—</button>
        </div>
        <div class="settings-content">
            <p>API Connection: <span class="api-status" id="apiStatus">Checking...</span></p>
            <div class="api-note">Note: Automatic mode uses the Gyazo API to fetch timestamps from screenshot URLs.</div>
            <div class="form-group">
                <label for="inputMode">Input Mode:</label>
                <div class="custom-dropdown" id="inputModeDropdown">
                    <div class="dropdown-toggle" id="inputModeToggle">Automatic (Gyazo)</div>
                    <div class="dropdown-menu" id="inputModeMenu">
                        <div class="dropdown-option" data-value="automatic">Automatic (Gyazo)</div>
                        <div class="dropdown-option" data-value="manual">Manual Input</div>
                    </div>
                </div>
            </div>
            <button class="theme-toggle" id="themeToggle">Toggle Theme</button>
            <button class="reset-btn" id="resetPreferences">Reset Preferences</button>
        </div>
    </div>

    <script>
        // Setup Page Logic
        const setupContainer = document.getElementById('setupContainer');
        const overlay = document.getElementById('overlay');
        const setupSlides = document.getElementById('setupSlides');
        const mainContainer = document.getElementById('mainContainer');
        const themeButtons = document.querySelectorAll('.theme-btn');
        const buttonColorInput = document.getElementById('buttonColor');
        const resetPreferences = document.getElementById('resetPreferences');
        const timeStartedNote = document.getElementById('timeStartedNote');
        const timeEndedNote = document.getElementById('timeEndedNote');
        const pinPrompt = document.getElementById('pinPrompt');
        const pinButton = document.getElementById('pinButton');
        const statusMessage = document.getElementById('statusMessage');
        const conversionSummary = document.getElementById('conversionSummary');
        const copyLogBtn = document.getElementById('copyLog');
        const output = document.getElementById('output');
        const outputText = document.getElementById('outputText');
        let currentStep = 0;

        function setStatus(message, type = 'info') {
            if (!statusMessage) return;
            statusMessage.textContent = message || '';
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = message ? 'block' : 'none';
        }

        function parseTimeString(value) {
            const match = /^([01]?\d|2[0-3]):([0-5]\d)$/.exec((value || '').trim());
            return match ? [parseInt(match[1], 10), parseInt(match[2], 10)] : null;
        }

        function formatTimezoneLabel(zone) {
            if (!zone) return 'timezone';
            const parts = zone.split('/');
            return parts[1] ? parts[1].replace('_', ' ') : parts[0];
        }

        function formatConvertedTime(result) {
            if (!result) return '--:--';
            const label = result.label ? ` ${result.label}` : '';
            const note = !result.label && result.note ? ` (${result.note})` : '';
            return `${result.time}${label || note}`;
        }

        function updateConversionSummary() {
            if (!conversionSummary) return;
            const prefs = JSON.parse(localStorage.getItem('userPrefs')) || {};
            const fromLabel = formatTimezoneLabel(prefs.yourTimezone) || 'your timezone';
            const toLabel = prefs.convertTimezone === 'disable'
                ? 'conversion off'
                : formatTimezoneLabel(prefs.convertTimezone) || 'target timezone';
            conversionSummary.textContent = `Converting ${fromLabel} â†’ ${toLabel}`;
        }

        function applyPreferences() {
            const prefs = JSON.parse(localStorage.getItem('userPrefs')) || {};
            if (prefs.theme) document.body.setAttribute('data-theme', prefs.theme);
            if (prefs.buttonColor) {
                document.documentElement.style.setProperty('--primary-color', prefs.buttonColor);
                document.documentElement.style.setProperty('--primary-hover', darkenColor(prefs.buttonColor));
            }
            timeStartedNote.textContent = `Enter time in ${prefs.yourTimezone?.split('/')[1] || 'your timezone'}`;
            timeEndedNote.textContent = `Enter time in ${prefs.yourTimezone?.split('/')[1] || 'your timezone'}`;
            updateConversionSummary();
        }

        function darkenColor(color) {
            const num = parseInt(color.slice(1), 16);
            const r = Math.max(0, ((num >> 16) & 255) - 20);
            const g = Math.max(0, ((num >> 8) & 255) - 20);
            const b = Math.max(0, (num & 255) - 20);
            return `#${(r << 16 | g << 8 | b).toString(16).padStart(6, '0')}`;
        }

        function showSetupPage() {
            if (!localStorage.getItem('userPrefs')) {
                setupContainer.classList.add('active');
                overlay.classList.add('active');
                mainContainer.style.display = 'none';
                updateSlide(0);
            } else {
                applyPreferences();
                setupContainer.classList.add('hidden');
                overlay.classList.remove('active');
                mainContainer.style.display = 'block';
            }
        }

        function updateSlide(step) {
            currentStep = step;
            setupSlides.style.transform = `translateX(-${step * 20}%)`;
            document.querySelectorAll('.setup-slide').forEach(slide => {
                slide.classList.remove('active');
                if (parseInt(slide.dataset.step) === step) slide.classList.add('active');
            });
        }

        themeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                themeButtons.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                document.body.setAttribute('data-theme', btn.dataset.theme);
            });
        });

        document.getElementById('nextStep0').addEventListener('click', () => updateSlide(1));
        document.getElementById('prevStep1').addEventListener('click', () => updateSlide(0));
        document.getElementById('nextStep1').addEventListener('click', () => document.getElementById('yourTimezone').value ? updateSlide(2) : alert('Please select a timezone'));
        document.getElementById('prevStep2').addEventListener('click', () => updateSlide(1));
        document.getElementById('nextStep2').addEventListener('click', () => document.getElementById('convertTimezone').value ? updateSlide(3) : alert('Please select a timezone'));
        document.getElementById('prevStep3').addEventListener('click', () => updateSlide(2));
        document.getElementById('nextStep3').addEventListener('click', () => {
            const username = document.getElementById('username').value;
            const duty = document.getElementById('duty').value;
            if (username && duty) updateSlide(4);
            else alert('Please enter both username and duty');
        });
        document.getElementById('prevStep4').addEventListener('click', () => updateSlide(3));
        document.getElementById('finishSetup').addEventListener('click', () => {
            const prefs = {
                theme: document.querySelector('.theme-btn.selected')?.dataset.theme || 'light',
                yourTimezone: document.getElementById('yourTimezone').value,
                convertTimezone: document.getElementById('convertTimezone').value,
                username: document.getElementById('username').value,
                duty: document.getElementById('duty').value,
                buttonColor: buttonColorInput.value
            };
            localStorage.setItem('userPrefs', JSON.stringify(prefs));
            applyPreferences();
            setupContainer.classList.remove('active');
            setupContainer.classList.add('hidden');
            overlay.classList.remove('active');
            mainContainer.style.display = 'block';
        });

        resetPreferences.addEventListener('click', () => {
            localStorage.removeItem('userPrefs');
            location.reload();
        });

        // Time Conversion
        function convertTime(time, fromZone, toZone, referenceDate = new Date()) {
            const parsed = parseTimeString(time);
            if (!parsed) return { time: '--:--', label: '', note: 'Enter time as HH:MM.' };
            if (!toZone) return { time, label: '', note: 'No target timezone selected.' };
            if (toZone === 'disable') return { time, label: '', note: 'Conversion disabled.' };
            const [hours, minutes] = parsed;
            const baseDate = new Date(referenceDate.getTime());
            baseDate.setHours(hours, minutes, 0, 0);

            const fromTime = new Date(baseDate.toLocaleString('en-US', { timeZone: fromZone || 'UTC' }));
            const toTime = fromTime.toLocaleString('en-US', { 
                timeZone: toZone,
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });

            const getOffsetLabel = (zone) => {
                if (zone === 'UTC') return 'UTC';
                const isDST = new Date().toLocaleString('en-US', { timeZone: zone }).includes('Daylight');
                switch (zone) {
                    case 'America/New_York': return isDST ? 'EDT' : 'EST';
                    case 'America/Los_Angeles': return isDST ? 'PDT' : 'PST';
                    case 'America/Chicago': return isDST ? 'CDT' : 'CST';
                    case 'Europe/London': return isDST ? 'BST' : 'GMT';
                    case 'Europe/Paris': return isDST ? 'CEST' : 'CET';
                    case 'Asia/Jerusalem': return isDST ? 'GMT+3' : 'GMT+2';
                    case 'Asia/Tokyo': return 'JST';
                    case 'Australia/Sydney': return isDST ? 'AEDT' : 'AEST';
                    case 'Pacific/Auckland': return isDST ? 'NZDT' : 'NZST';
                    case 'Asia/Dubai': return 'GST';
                    default: return '';
                }
            };

            return { time: toTime, label: getOffsetLabel(toZone), note: '' };
        }

        async function fetchGyazoTimestamp(url) {
            if (!url || !url.includes("gyazo.com")) return null;
            try {
                const response = await fetch(`/.netlify/functions/getGyazoTimestamp?url=${encodeURIComponent(url)}`);
                if (!response.ok) throw new Error(`Status ${response.status}`);
                const data = await response.json();
                return data.uploaded_at || null;
            } catch (error) {
                console.error("Error fetching Gyazo timestamp:", error);
                return null;
            }
        }

        async function checkApiStatus() {
            const apiStatus = document.getElementById('apiStatus');
            apiStatus.textContent = 'Checking...';
            apiStatus.classList.remove('connected', 'disconnected');

            try {
                const response = await fetch('/.netlify/functions/getGyazoTimestamp?url=https://gyazo.com/1c063495185f1c3a8e919194af7dd278', {
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.uploaded_at) {
                        apiStatus.textContent = 'Connected';
                        apiStatus.classList.add('connected');
                    } else {
                        throw new Error('Invalid API response');
                    }
                } else {
                    throw new Error('API request failed');
                }
            } catch (error) {
                apiStatus.textContent = 'Disconnected';
                apiStatus.classList.add('disconnected');
                console.error('API Status Check Error:', error);
            }
        }

        function updateInputMode(mode) {
            const timeStartedInput = document.getElementById('timeStarted');
            const timeEndedInput = document.getElementById('timeEnded');
            if (mode === 'automatic') {
                timeStartedInput.disabled = true;
                timeEndedInput.disabled = true;
                timeStartedInput.placeholder = 'Auto-fill from Gyazo';
                timeEndedInput.placeholder = 'Auto-fill from Gyazo';
            } else {
                timeStartedInput.disabled = false;
                timeEndedInput.disabled = false;
                timeStartedInput.placeholder = 'e.g., 14:30';
                timeEndedInput.placeholder = 'e.g., 15:30';
            }
        }

        function setupGyazoListeners() {
            const tablistStarted = document.getElementById('tablistStarted');
            const tablistEnded = document.getElementById('tablistEnded');
            const timeStarted = document.getElementById('timeStarted');
            const timeEnded = document.getElementById('timeEnded');
            const inputMode = document.getElementById('inputModeToggle').dataset.value;

            tablistStarted.addEventListener('input', function () {
                if (!this.value) timeStarted.value = '';
            });

            tablistEnded.addEventListener('input', function () {
                if (!this.value) timeEnded.value = '';
            });

            if (inputMode === 'automatic') {
                tablistStarted.addEventListener('change', async function () {
                    const url = this.value;
                    if (!url.includes("gyazo.com")) return;
                    const timestamp = await fetchGyazoTimestamp(url);
                    if (timestamp) {
                        const date = new Date(timestamp);
                        const prefs = JSON.parse(localStorage.getItem('userPrefs')) || {};
                        const localTime = date.toLocaleTimeString('en-US', { 
                            timeZone: prefs.yourTimezone || 'America/New_York',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        });
                        timeStarted.value = localTime;
                    }
                });

                tablistEnded.addEventListener('change', async function () {
                    const url = this.value;
                    if (!url.includes("gyazo.com")) return;
                    const timestamp = await fetchGyazoTimestamp(url);
                    if (timestamp) {
                        const date = new Date(timestamp);
                        const prefs = JSON.parse(localStorage.getItem('userPrefs')) || {};
                        const localTime = date.toLocaleTimeString('en-US', { 
                            timeZone: prefs.yourTimezone || 'America/New_York',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        });
                        timeEnded.value = localTime;
                    }
                });
            }
        }

        document.getElementById('dutyForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            setStatus('');
            if (copyLogBtn) copyLogBtn.disabled = true;
            
            const submitButton = document.querySelector('button[type="submit"]');
            submitButton.classList.add('loading');
            submitButton.disabled = true;
            output.style.display = 'none';

            const prefs = JSON.parse(localStorage.getItem('userPrefs')) || {};
            const dutyScreenshot = document.getElementById('dutyScreenshot').value.trim();
            const timeStarted = document.getElementById('timeStarted').value.trim();
            const tablistStarted = document.getElementById('tablistStarted').value.trim();
            const timeEnded = document.getElementById('timeEnded').value.trim();
            const tablistEnded = document.getElementById('tablistEnded').value.trim();
            const inputMode = inputModeToggle.dataset.value || 'automatic';

            const validationErrors = [];
            if (inputMode === 'manual') {
                if (!parseTimeString(timeStarted)) validationErrors.push('Enter Time Started as HH:MM (24h).');
                if (!parseTimeString(timeEnded)) validationErrors.push('Enter Time Ended as HH:MM (24h).');
            } else {
                if (!tablistStarted.includes('gyazo.com') || !tablistEnded.includes('gyazo.com')) {
                    validationErrors.push('Provide Gyazo links for automatic mode or switch to Manual Input.');
                }
            }

            if (validationErrors.length) {
                setStatus(validationErrors.join(' '), 'error');
                submitButton.classList.remove('loading');
                submitButton.disabled = false;
                return;
            }

            setStatus('Generating log, please wait...', 'info');

            let startTimestamp = null;
            let endTimestamp = null;
            if (inputMode === 'automatic') {
                [startTimestamp, endTimestamp] = await Promise.all([
                    fetchGyazoTimestamp(tablistStarted),
                    fetchGyazoTimestamp(tablistEnded)
                ]);
            }
            
            const startResult = convertTime(timeStarted, prefs.yourTimezone, prefs.convertTimezone, startTimestamp ? new Date(startTimestamp) : new Date());
            const endResult = convertTime(timeEnded, prefs.yourTimezone, prefs.convertTimezone, endTimestamp ? new Date(endTimestamp) : new Date());
            const header = `Username: ${prefs.username || '798ty7th'}
Duty: ${prefs.duty || 'ARD Duties'}
Mode: ${inputMode === 'automatic' ? 'Automatic (Gyazo timestamps)' : 'Manual input'}`;

            const logText = `${header}
${dutyScreenshot || 'Duty Screenshot: none provided'}

Time Started (${formatTimezoneLabel(prefs.yourTimezone)}): ${timeStarted || '--'}
Converted: ${formatConvertedTime(startResult)}
Tablist Started: ${tablistStarted}

Time Ended (${formatTimezoneLabel(prefs.yourTimezone)}): ${timeEnded || '--'}
Converted: ${formatConvertedTime(endResult)}
Tablist Ended: ${tablistEnded}`;

            await new Promise(resolve => setTimeout(resolve, 400));

            outputText.textContent = logText;
            output.style.display = 'block';
            submitButton.classList.remove('loading');
            submitButton.disabled = false;
            if (copyLogBtn) copyLogBtn.disabled = false;

            const notes = [startResult.note, endResult.note].filter(Boolean);
            if (inputMode === 'automatic' && (!startTimestamp || !endTimestamp)) {
                setStatus('Generated log, but one or both Gyazo timestamps were unavailable. Confirm links or switch to manual.', 'error');
            } else if (notes.length) {
                setStatus(notes.join(' '), 'info');
            } else {
                setStatus('Log generated successfully.', 'success');
            }
        });

        const settingsBtn = document.querySelector('.settings-btn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettings = document.getElementById('closeSettings');
        const themeToggle = document.getElementById('themeToggle');
        const inputModeToggle = document.getElementById('inputModeToggle');
        const inputModeMenu = document.getElementById('inputModeMenu');
        const inputModeDropdown = document.getElementById('inputModeDropdown');
        const dropdownOptions = document.querySelectorAll('.dropdown-option');

        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('active');
            overlay.classList.add('active');
            checkApiStatus();
        });

        closeSettings.addEventListener('click', () => {
            settingsModal.classList.remove('active');
            overlay.classList.remove('active');
            inputModeMenu.classList.remove('active');
            inputModeToggle.classList.remove('active');
        });

        overlay.addEventListener('click', () => {
            settingsModal.classList.remove('active');
            overlay.classList.remove('active');
            inputModeMenu.classList.remove('active');
            inputModeToggle.classList.remove('active');
        });

        themeToggle.addEventListener('click', function () {
            const prefs = JSON.parse(localStorage.getItem('userPrefs')) || {};
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', newTheme);
            prefs.theme = newTheme;
            localStorage.setItem('userPrefs', JSON.stringify(prefs));
        });

        inputModeToggle.addEventListener('click', () => {
            inputModeMenu.classList.toggle('active');
            inputModeToggle.classList.toggle('active');
        });

        dropdownOptions.forEach(option => {
            option.addEventListener('click', () => {
                const value = option.dataset.value;
                const text = option.textContent;
                inputModeToggle.textContent = text;
                inputModeToggle.dataset.value = value;
                localStorage.setItem('inputMode', value);
                updateInputMode(value);
                inputModeMenu.classList.remove('active');
                inputModeToggle.classList.remove('active');
                setupGyazoListeners();
            });
        });

        document.addEventListener('click', (e) => {
            if (!inputModeDropdown.contains(e.target)) {
                inputModeMenu.classList.remove('active');
                inputModeToggle.classList.remove('active');
            }
        });

        copyLogBtn.addEventListener('click', async () => {
            if (!outputText.textContent.trim()) return;
            try {
                await navigator.clipboard.writeText(outputText.textContent);
                setStatus('Copied log to clipboard.', 'success');
            } catch (error) {
                console.error('Clipboard error:', error);
                setStatus('Unable to copy to clipboard in this browser.', 'error');
            }
        });

        // Safari on MacBook Detection and Pin Prompt
        function isSafariOnMac() {
            const ua = navigator.userAgent;
            return /Macintosh/.test(ua) && /Safari/.test(ua) && !/Chrome/.test(ua) && !/Firefox/.test(ua);
        }

        function showPinPrompt() {
            if (isSafariOnMac() && !localStorage.getItem('pinPromptDismissed')) {
                pinPrompt.classList.add('show');
                pinButton.addEventListener('click', () => {
                    localStorage.setItem('pinPromptDismissed', 'true');
                    pinPrompt.classList.remove('show');
                    alert('To pin Duty State, drag the URL from the address bar to your Dock or use File > Add to Dock.');
                });
            }
        }

        // PWA Installation Prompt (for browsers that support it)
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Optionally show a custom install button here if not on Safari
        });

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registered:', reg))
                    .catch(err => console.error('Service Worker registration failed:', err));
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateConversionSummary();
            if (copyLogBtn) copyLogBtn.disabled = true;
            showSetupPage();
            const savedInputMode = localStorage.getItem('inputMode') || 'automatic';
            const initialText = savedInputMode === 'automatic' ? 'Automatic (Gyazo)' : 'Manual Input';
            inputModeToggle.textContent = initialText;
            inputModeToggle.dataset.value = savedInputMode;
            updateInputMode(savedInputMode);
            setupGyazoListeners();
            showPinPrompt();
        });
    </script>
</body>
</html>
